---
import Layout from '../layouts/Layout.astro';

const title = '2025 Schulungswoche - Streamplan';

// Language streams data
const languages = [
	'S01 - English',
	'S02 – Japanisch',
	'S03 – Spanisch',
	'S04 – Farsi / Persisch',
	'S05 – Polnisch',
	'S06 – Koreanisch',
	'S07 – Französisch',
	'S09 – Schwedisch',
	'S10 – Chinesisch',
	'S11 – Mongolisch',
	'S12 – Niederländisch',
	'S13 – Italienisch',
	'S14 – Tschechisch',
	'S15 – Slowenisch',
	'S16 – Portugisisch',
];

// Schedule dates
const dates = ['2025-12-27', '2025-12-28', '2025-12-29', '2025-12-30', '2025-12-31', '2026-01-01'];

// Schedule data for each language and date
type Location = 'igr-to-igr' | 'aula-to-igr' | 'igr-to-aula' | 'none';

interface ScheduleItem {
	location: Location;
	note?: string;
}

interface ScheduleData {
	[date: string]: {
		morning?: ScheduleItem[];
		afternoon?: ScheduleItem[];
		evening?: ScheduleItem[];
	};
}

const schedules: Record<string, ScheduleData> = {
	'S01 - English': dates.reduce(
		(acc, date) => ({
			...acc,
			[date]: {
				morning: [{ location: 'igr-to-igr' }],
				afternoon: [{ location: 'igr-to-igr' }],
				evening: [{ location: 'igr-to-igr' }],
			},
		}),
		{},
	),
	'S02 – Japanisch': {
		'2025-12-27': {
			afternoon: [
				{ location: 'aula-to-igr', note: '15:00 – 16:30' },
				{ location: 'igr-to-igr', note: '16:30 – 18:00' },
			],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-28': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'igr-to-igr', note: 'aula-to-igr war geplant, aber Keiko übersetzt' }],
		},
		'2025-12-29': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'aula-to-igr' }],
		},
		'2025-12-30': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-31': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2026-01-01': {
			morning: [{ location: 'aula-to-igr' }],
		},
	},
	'S11 – Mongolisch': {
		'2025-12-28': {
			morning: [
				{ location: 'igr-to-igr', note: '09:00 – 11:00' },
				{ location: 'aula-to-igr', note: '11:00 – 12:00' },
			],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'none' }],
		},
		'2025-12-29': {
			morning: [
				{ location: 'igr-to-igr', note: '09:00 – 10:30' },
				{ location: 'aula-to-igr', note: '10:30 – 12:00' },
			],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'none' }],
		},
		'2025-12-30': {
			morning: [
				{ location: 'igr-to-igr', note: '09:00 – 10:30' },
				{ location: 'aula-to-igr', note: '10:30 – 12:00' },
			],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'none' }],
		},
		'2025-12-31': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'none' }],
		},
		'2026-01-01': {
			morning: [{ location: 'igr-to-igr' }],
		},
	},
	'S03 – Spanisch': {
		'2025-12-28': {
			morning: [{ location: 'igr-to-igr', note: 'Aula hatte schlechte Qualität' }],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
	},
	'S05 – Polnisch': {
		'2025-12-28': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'aula-to-igr' }],
		},
	},
	'S06 – Koreanisch': {
		'2025-12-28': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'none' }],
		},
		'2025-12-29': {
			evening: [{ location: 'none' }],
		},
		'2025-12-30': {
			evening: [{ location: 'none' }],
		},
		'2025-12-31': {
			evening: [{ location: 'none' }],
		},
	},
	'S07 – Französisch': {
		'2025-12-28': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'aula-to-igr' }],
		},
	},
	'S10 – Chinesisch': {
		'2025-12-27': {
			evening: [{ location: 'none' }],
		},
		'2025-12-28': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'none' }],
		},
		'2025-12-29': {
			evening: [{ location: 'none' }],
		},
		'2025-12-30': {
			evening: [{ location: 'none' }],
		},
		'2025-12-31': {
			evening: [{ location: 'none' }],
		},
	},
	'S12 – Niederländisch': {
		'2025-12-28': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'aula-to-igr' }],
		},
	},
	'S13 – Italienisch': {
		'2025-12-28': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'aula-to-igr' }],
		},
	},
	'S15 – Slowenisch': {
		'2025-12-28': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'aula-to-igr' }],
		},
	},
	'S16 – Portugisisch': {
		'2025-12-27': {
			morning: [{ location: 'igr-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-28': {
			morning: [{ location: 'igr-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
	},
	'S04 – Farsi / Persisch': {
		'2025-12-27': {
			morning: [{ location: 'none' }],
			afternoon: [{ location: 'none' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-28': {
			morning: [{ location: 'none' }],
			afternoon: [{ location: 'none' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-29': {
			morning: [{ location: 'none' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-30': {
			morning: [{ location: 'none' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'aula-to-igr' }],
		},
		'2025-12-31': {
			morning: [{ location: 'none' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [
				{ location: 'igr-to-igr', note: 'bis 22:45' },
				{ location: 'aula-to-igr', note: 'ab 22:45' },
			],
		},
	},
	'S14 – Tschechisch': {
		'2025-12-27': {
			morning: [{ location: 'igr-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-28': {
			morning: [{ location: 'igr-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-29': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-30': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-31': {
			morning: [{ location: 'aula-to-igr' }],
			afternoon: [{ location: 'igr-to-igr' }],
			evening: [
				{ location: 'igr-to-igr', note: 'bis 22:45' },
				{ location: 'aula-to-igr', note: 'ab 22:45' },
			],
		},
		'2026-01-01': {
			morning: [{ location: 'igr-to-igr' }],
		},
	},
	'S09 – Schwedisch': {
		'2025-12-27': {
			afternoon: [
				{ location: 'igr-to-igr', note: '14:00 – 16:00' },
				{ location: 'aula-to-igr', note: '16:00 – 17:30' },
			],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-28': {
			morning: [
				{ location: 'igr-to-igr', note: '09:00 – 11:00' },
				{ location: 'aula-to-igr', note: '11:00 – 12:00' },
			],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-29': {
			morning: [{ location: 'igr-to-igr' }],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-30': {
			morning: [{ location: 'igr-to-igr' }],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'igr-to-igr' }],
		},
		'2025-12-31': {
			morning: [{ location: 'igr-to-igr' }],
			afternoon: [{ location: 'aula-to-igr' }],
			evening: [{ location: 'aula-to-igr' }],
		},
		'2026-01-01': {
			morning: [{ location: 'aula-to-igr' }],
		},
	},
};
---

<Layout title={title} type="subpage">
	<div class="space-y-8 flex flex-col gap-12 items-stretch max-w-4xl mx-auto">
		{
			dates.map(date => {
				// Determine which columns to show
				const showMorning = date !== '2025-12-27';
				const showAfternoon = date !== '2026-01-01';
				const showEvening = date !== '2026-01-01';

				return (
					<section data-date={date} class="">
						<h2
							class="text-xl font-semibold text-text-primary mb-4 pb-2 border-b border-border-primary flex items-center gap-3"
							data-date={date}
						>
							<span class="date-text">{date}</span>
						</h2>

						<div class="overflow-x-auto -mx-4 px-4">
							<table class="w-full border-collapse bg-bg-secondary border border-border-secondary shadow-lg rounded-lg overflow-hidden text-sm">
								<thead class="bg-bg-tertiary border-b border-border-primary">
									<tr>
										<th class="px-4 py-3 text-left font-semibold text-text-secondary whitespace-nowrap">
											Sprachen
										</th>
										{showMorning && (
											<th class="px-4 py-3 text-left font-semibold text-text-secondary whitespace-nowrap">
												<div>Morgens</div>
												<span class="text-xs font-normal text-text-tertiary">9:00 – 12 Uhr</span>
											</th>
										)}
										{showAfternoon && (
											<th class="px-4 py-3 text-left font-semibold text-text-secondary whitespace-nowrap">
												<div>Nachmittags</div>
												<span class="text-xs font-normal text-text-tertiary">15 – 17 Uhr</span>
											</th>
										)}
										{showEvening && (
											<th class="px-4 py-3 text-left font-semibold text-text-secondary whitespace-nowrap">
												<div>Abends</div>
												<span class="text-xs font-normal text-text-tertiary">19:30 – 22 Uhr</span>
											</th>
										)}
									</tr>
								</thead>
								<tbody>
									{languages.map((lang, index) => {
										const langSchedule = schedules[lang];
										const dateSchedule = langSchedule?.[date];

										const getLocationClass = (location: Location): string => {
											switch (location) {
												case 'igr-to-igr':
													return 'location-igr';
												case 'aula-to-igr':
													return 'location-aula';
												case 'igr-to-aula':
													return 'location-igr-aula';
												case 'none':
													return 'location-igr';
											}
										};

										const getLocationText = (location: Location): string => {
											switch (location) {
												case 'igr-to-igr':
													return 'von IGR für IGR';
												case 'aula-to-igr':
													return 'von Aula für IGR';
												case 'igr-to-aula':
													return 'von IGR für Aula';
												case 'none':
													return '—';
											}
										};

										const renderSchedule = (items: ScheduleItem[] | undefined) => {
											if (!items || items.length === 0) return '';

											return items.map(item => (
												<p
													class={`${item.note ? 'mb-2 last:mb-0' : ''} ${item.location === 'none' ? 'ml-12' : ''}`}
												>
													<span class={getLocationClass(item.location)}>
														{getLocationText(item.location)}
													</span>
													{item.note && (
														<span class="block text-xs text-text-tertiary">{item.note}</span>
													)}
												</p>
											));
										};

										return (
											<tr
												class={`
										border-b border-border-primary last:border-b-0
										${index % 2 === 1 ? 'bg-bg-tertiary' : ''}
										hover:bg-bg-hover transition-colors
									`}
											>
												<td class="px-4 py-3 font-medium text-text-primary whitespace-nowrap">
													{lang}
												</td>
												{showMorning && (
													<td class="px-4 py-3 text-text-secondary">
														{renderSchedule(dateSchedule?.morning)}
													</td>
												)}
												{showAfternoon && (
													<td class="px-4 py-3 text-text-secondary">
														{renderSchedule(dateSchedule?.afternoon)}
													</td>
												)}
												{showEvening && (
													<td class="px-4 py-3 text-text-secondary">
														{renderSchedule(dateSchedule?.evening)}
													</td>
												)}
											</tr>
										);
									})}
								</tbody>
							</table>
						</div>
					</section>
				);
			})
		}
	</div>
</Layout>

<script>
	import { isToday, parseISO } from 'date-fns';
	import { de } from 'date-fns/locale';
	import { toZonedTime, formatInTimeZone } from 'date-fns-tz';

	function getCurrentTimeslot(): 'morning' | 'afternoon' | 'evening' | null {
		const now = new Date();
		const hour = now.getHours();
		const minute = now.getMinutes();

		// Morning: 9:00 - 12:00
		if (hour >= 9 && hour < 12) return 'morning';

		// Afternoon: 15:00 - 17:00
		if (hour >= 15 && hour < 17) return 'afternoon';

		// Evening: 19:30 - 22:00
		if (hour >= 19 && hour < 22) {
			if (hour === 19 && minute < 30) return null;
			return 'evening';
		}

		return null;
	}

	function getNextTimeslot(): 'morning' | 'afternoon' | 'evening' | null {
		const now = new Date();
		const hour = now.getHours();
		const minute = now.getMinutes();

		// Before morning
		if (hour < 9) return 'morning';

		// Between morning (12:00) and afternoon (15:00)
		if (hour >= 12 && hour < 15) return 'afternoon';

		// Between afternoon (17:00) and evening (19:30)
		if (hour >= 17 && hour < 19) return 'evening';
		if (hour === 19 && minute < 30) return 'evening';

		return null;
	}

	function enhanceDates(): void {
		// Get browser's timezone
		const browserTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
		const sections = document.querySelectorAll('section[data-date]');

		sections.forEach(section => {
			const dateStr = section.getAttribute('data-date');
			if (!dateStr) return;

			// Parse as UTC date and convert to browser's local timezone
			const utcDate = parseISO(dateStr);
			const localDate = toZonedTime(utcDate, browserTimeZone);

			const heading = section.querySelector('h2[data-date]');
			const dateSpan = heading?.querySelector('.date-text');
			const table = section.querySelector('table');

			if (!dateSpan) return;

			// Format the date nicely in German, using browser's timezone
			const formattedDate = formatInTimeZone(utcDate, browserTimeZone, 'EEEE, d. MMMM yyyy', {
				locale: de,
			});

			// Check if this is today (using browser's local timezone)
			const isTodayDate = isToday(localDate);

			if (isTodayDate) {
				// Add "Heute" badge
				dateSpan.textContent = formattedDate;

				const badge = document.createElement('span');
				badge.className =
					'inline-flex items-center px-3 py-1 text-xs font-semibold uppercase tracking-wide bg-today-bg text-today-text border border-today-border rounded-full';
				badge.textContent = 'Heute';
				heading?.appendChild(badge);

				// Highlight today's table
				table?.classList.add('ring-2', 'ring-today-border');

				// Add timeslot indicator
				const currentTimeslot = getCurrentTimeslot();
				const nextTimeslot = getNextTimeslot();

				if (currentTimeslot) {
					highlightTimeslot(section, currentTimeslot, 'Jetzt');
				} else if (nextTimeslot) {
					highlightTimeslot(section, nextTimeslot, 'Nächste');
				}

				// Scroll to today's section
				setTimeout(() => {
					heading?.scrollIntoView({ behavior: 'smooth', block: 'start' });
				}, 300);
			} else {
				dateSpan.textContent = formattedDate;
			}
		});
	}

	function highlightTimeslot(
		section: Element,
		timeslot: 'morning' | 'afternoon' | 'evening',
		badgeText: string,
	): void {
		const table = section.querySelector('table');
		if (!table) return;

		const thead = table.querySelector('thead');
		if (!thead) return;

		const headers = thead.querySelectorAll('th');
		let headerIndex = -1;

		// Find the timeslot header index (skip the first "Sprachen" column)
		if (timeslot === 'morning') headerIndex = 1;
		if (timeslot === 'afternoon') {
			// Check if morning column exists
			const morningHeader = headers[1]?.textContent?.includes('Morgens');
			headerIndex = morningHeader ? 2 : 1;
		}
		if (timeslot === 'evening') {
			// Calculate based on existing columns
			const hasMorning = headers[1]?.textContent?.includes('Morgens');
			const hasAfternoon = headers[hasMorning ? 2 : 1]?.textContent?.includes('Nachmittags');
			headerIndex = hasMorning && hasAfternoon ? 3 : hasMorning || hasAfternoon ? 2 : 1;
		}

		if (headerIndex > 0 && headers[headerIndex]) {
			const header = headers[headerIndex];
			const badge = document.createElement('span');
			badge.className =
				'inline-flex items-center ml-2 px-2 py-0.5 text-xs font-semibold uppercase tracking-wide bg-current-timeslot-bg text-current-timeslot-text rounded-full';
			badge.textContent = badgeText;
			header.appendChild(badge);
		}
	}

	// Run on initial load
	enhanceDates();

	// Run on Astro view transitions
	document.addEventListener('astro:after-swap', enhanceDates);
</script>
