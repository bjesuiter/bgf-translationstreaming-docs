---
// Client-side script to enhance date headings with:
// 1. Nicely formatted German dates (e.g., "Samstag, 27. Dezember 2025")
// 2. "Heute" badge for today's date
// 3. Highlight today's table
// 4. Wrap tables for horizontal scroll on mobile
---

<script>
	import { format, isToday, parseISO } from 'date-fns';
	import { de } from 'date-fns/locale';

	function wrapTablesForMobile(): void {
		// Wrap all tables in a scrollable container for mobile
		const tables = document.querySelectorAll('.prose table:not(.wrapped)');

		tables.forEach((table) => {
			// Mark as wrapped to avoid double-wrapping
			table.classList.add('wrapped');

			// Create wrapper div
			const wrapper = document.createElement('div');
			wrapper.className = 'table-wrapper';

			// Insert wrapper before table and move table inside
			table.parentNode?.insertBefore(wrapper, table);
			wrapper.appendChild(table);
		});
	}

	function enhanceDates(): void {
		// Find all h2 elements that contain date patterns (YYYY-MM-DD)
		const dateHeadings = document.querySelectorAll('.prose h2');

		dateHeadings.forEach((heading) => {
			const text = heading.textContent?.trim() || '';

			// Check if the heading is a date in YYYY-MM-DD format
			const dateMatch = text.match(/^(\d{4}-\d{2}-\d{2})$/);

			if (dateMatch) {
				const dateStr = dateMatch[1];
				const date = parseISO(dateStr);

				// Format the date nicely in German
				// e.g., "Samstag, 27. Dezember 2025"
				const formattedDate = format(date, 'EEEE, d. MMMM yyyy', { locale: de });

				// Set data attribute for potential CSS targeting
				heading.setAttribute('data-date', dateStr);

				// Check if this is today
				const isTodayDate = isToday(date);

				if (isTodayDate) {
					// Create the formatted content with "Heute" badge
					heading.innerHTML = `
						<span>${formattedDate}</span>
						<span class="today-badge">Heute</span>
					`;
					heading.classList.add('is-today');

					// Find and highlight the next table (might be wrapped)
					let nextElement = heading.nextElementSibling;
					if (nextElement?.classList.contains('table-wrapper')) {
						const table = nextElement.querySelector('table');
						table?.classList.add('is-today');
					} else if (nextElement?.tagName === 'TABLE') {
						nextElement.classList.add('is-today');
					}

					// Scroll to today's section (with a small delay for page load)
					setTimeout(() => {
						heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
					}, 300);
				} else {
					// Just update the text with formatted date
					heading.textContent = formattedDate;
				}
			}
		});
	}

	function init(): void {
		wrapTablesForMobile();
		enhanceDates();
	}

	// Run on initial load
	init();

	// Run on Astro view transitions
	document.addEventListener('astro:after-swap', init);
</script>
